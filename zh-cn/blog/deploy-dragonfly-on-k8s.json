{
  "filename": "deploy-dragonfly-on-k8s.md",
  "__html": "<h1>在Kubernetes上部署Dragonfly</h1>\n<p align='right'>by <a href=\"https://github.com/shenlanse\">shenlanse</a></p>\n<h2>1 说明</h2>\n<ul>\n<li><code>supernode</code> 组件至少需要两节点部署，hostnetwork，一般部署在管理节点，比如k8s master上。</li>\n<li><code>supernode</code> 需要使用8001、8002端口。如果跟kube-apiserver部署在一个节点上，需要确保不要有端口冲突。</li>\n<li><code>supernode</code> 所在节点对网络带宽、磁盘空间、磁盘IO要求较高。</li>\n<li><code>dfdaemon</code> 组件使用daemonset部署在所有的node节点上，hostnetwork，占用65001端口</li>\n<li>需要修改所有node的docker启动参数 <em><strong>--registry-mirror <a href=\"http://127.0.0.1:65001\">http://127.0.0.1:65001</a></strong></em>。</li>\n</ul>\n<h2>2 部署</h2>\n<p>其中 <code>supernode</code> 部署在管理节点，<code>dfget</code> 和<code>dfdaemon</code> 部署在所有的node上面。</p>\n<h3>2.1 supernode</h3>\n<p>三种部署方式：</p>\n<ul>\n<li>直接跑docker 容器</li>\n<li>kubelet管理静态pod</li>\n<li>deployment部署</li>\n</ul>\n<blockquote>\n<p>NOTE： 官方提供的镜像是0.2.0，继委自己打了个0.3.0的镜像，这个镜像是基于master分支的。问了一下已经部署上线蜻蜓的去哪儿网和美团的工程师，他们用的是官方的0.2.0镜像。</p>\n</blockquote>\n<h5>2.1.1 docker容器</h5>\n<pre><code class=\"language-bash\">docker run -d -p 8001:8001 -p 8002:8002 -v /data/<span class=\"hljs-built_in\">log</span>/supernode/:/home/admin/supernode/logs/ -v /data/supernode/repo/:/home/admin/supernode/repo/ hub.c.163.com/hzlilanqing/supernode:0.3.0\n</code></pre>\n<h5>2.1.2 静态pod</h5>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Pod</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">supernode</span>\n  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">kube-system</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">containers:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">hub.c.163.com/hzlilanqing/supernode:0.3.0</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">supernode</span>\n    <span class=\"hljs-attr\">ports:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-number\">8080</span>\n      <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">tomcat</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-number\">8001</span>\n      <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">register</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-number\">8002</span>\n      <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">download</span>\n    <span class=\"hljs-attr\">resources:</span>\n      <span class=\"hljs-attr\">requests:</span>\n        <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">\"2\"</span>\n        <span class=\"hljs-attr\">memory:</span> <span class=\"hljs-string\">4Gi</span>\n    <span class=\"hljs-attr\">volumeMounts:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/etc/localtime</span>\n      <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ltime</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/home/admin/supernode/logs/</span>\n      <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">log</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/home/admin/supernode/repo/</span>\n      <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">data</span>\n  <span class=\"hljs-attr\">hostNetwork:</span> <span class=\"hljs-literal\">true</span>\n  <span class=\"hljs-attr\">dnsPolicy:</span> <span class=\"hljs-string\">ClusterFirstWithHostNet</span>\n  <span class=\"hljs-attr\">restartPolicy:</span> <span class=\"hljs-string\">Always</span>\n  <span class=\"hljs-attr\">tolerations:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">effect:</span> <span class=\"hljs-string\">NoExecute</span>\n    <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">Exists</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">effect:</span> <span class=\"hljs-string\">NoSchedule</span>\n    <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">Exists</span>\n  <span class=\"hljs-attr\">nodeSelector:</span>\n    <span class=\"hljs-attr\">node-role.kubernetes.io/master:</span> <span class=\"hljs-string\">\"\"</span>\n  <span class=\"hljs-attr\">volumes:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hostPath:</span>\n      <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/etc/localtime</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ltime</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hostPath:</span>\n      <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/data/log/supernode</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">log</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hostPath:</span>\n      <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/data/supernode/repo/</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">data</span>\n</code></pre>\n<h5>2.1.3 deployment</h5>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps/v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Deployment</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">labels:</span>\n    <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">supernode</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">supernode</span>\n  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">kube-system</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">replicas:</span> <span class=\"hljs-number\">2</span>\n  <span class=\"hljs-attr\">selector:</span>\n    <span class=\"hljs-attr\">matchLabels:</span>\n      <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">supernode</span>\n  <span class=\"hljs-attr\">template:</span>\n    <span class=\"hljs-attr\">metadata:</span>\n      <span class=\"hljs-attr\">labels:</span>\n        <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">supernode</span>\n      <span class=\"hljs-attr\">annotations:</span>\n        <span class=\"hljs-attr\">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class=\"hljs-string\">\"\"</span>\n    <span class=\"hljs-attr\">spec:</span>\n      <span class=\"hljs-attr\">containers:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">hub.c.163.com/hzlilanqing/supernode:0.3.0</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">supernode</span>\n        <span class=\"hljs-attr\">ports:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-number\">8080</span>\n          <span class=\"hljs-attr\">hostPort:</span> <span class=\"hljs-number\">8080</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">tomcat</span>\n          <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">TCP</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-number\">8001</span>\n          <span class=\"hljs-attr\">hostPort:</span> <span class=\"hljs-number\">8001</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">register</span>\n          <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">TCP</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-number\">8002</span>\n          <span class=\"hljs-attr\">hostPort:</span> <span class=\"hljs-number\">8002</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">download</span>\n          <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">TCP</span>\n        <span class=\"hljs-attr\">resources:</span>\n          <span class=\"hljs-attr\">requests:</span>\n            <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">\"2\"</span>\n            <span class=\"hljs-attr\">memory:</span> <span class=\"hljs-string\">4Gi</span>\n        <span class=\"hljs-attr\">volumeMounts:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/etc/localtime</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ltime</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/home/admin/supernode/logs/</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">log</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/home/admin/supernode/repo/</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">data</span>\n      <span class=\"hljs-attr\">hostNetwork:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-attr\">dnsPolicy:</span> <span class=\"hljs-string\">ClusterFirstWithHostNet</span>\n      <span class=\"hljs-attr\">restartPolicy:</span> <span class=\"hljs-string\">Always</span>\n      <span class=\"hljs-attr\">tolerations:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">effect:</span> <span class=\"hljs-string\">NoExecute</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">Exists</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">effect:</span> <span class=\"hljs-string\">NoSchedule</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">Exists</span>\n      <span class=\"hljs-attr\">nodeSelector:</span>\n        <span class=\"hljs-attr\">node-role.kubernetes.io/master:</span> <span class=\"hljs-string\">\"\"</span>\n      <span class=\"hljs-attr\">volumes:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hostPath:</span>\n          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/etc/localtime</span>\n          <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">\"\"</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ltime</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hostPath:</span>\n          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/data/log/supernode</span>\n          <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">\"\"</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">log</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hostPath:</span>\n          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/data/supernode/repo/</span>\n          <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">\"\"</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">data</span>\n\n<span class=\"hljs-meta\">---</span>\n\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Service</span>\n<span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">supernode</span>\n  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">kube-system</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">selector:</span>\n    <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">supernode</span>\n  <span class=\"hljs-attr\">ports:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">register</span>\n    <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">TCP</span>\n    <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">8001</span>\n    <span class=\"hljs-attr\">targetPort:</span> <span class=\"hljs-number\">8001</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">download</span>\n    <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">TCP</span>\n    <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">8002</span>\n    <span class=\"hljs-attr\">targetPort:</span> <span class=\"hljs-number\">8002</span>\n\n</code></pre>\n<h4>2.2 dfget &amp; dfdaemon</h4>\n<ul>\n<li>\n<p><strong>Dockerfile</strong></p>\n<pre><code class=\"language-dockerfile\"><span class=\"hljs-keyword\">FROM</span> debian:<span class=\"hljs-number\">7</span>\n \n<span class=\"hljs-keyword\">MAINTAINER</span> <span class=\"hljs-string\">\"hzlilanqing@corp.netease.com\"</span>\n\n<span class=\"hljs-keyword\">RUN</span><span class=\"bash\"> apt-get update &amp;&amp; apt-get install -y python wget &amp;&amp; \\\n    wget http://dragonfly-os.oss-cn-beijing.aliyuncs.com/df-client_0.2.0_linux_amd64.tar.gz  &amp;&amp; \\\n    tar -zxf df-client_0.2.0_linux_amd64.tar.gz &amp;&amp; \\\n    cp -R df-client/* /usr/<span class=\"hljs-built_in\">local</span>/bin/ &amp;&amp; \\\n    rm -rf df-client_0.2.0_linux_amd64.tar.gz df-client</span>\n\n<span class=\"hljs-keyword\">COPY</span><span class=\"bash\"> ./dragonfly.conf /etc/</span>\n\n<span class=\"hljs-keyword\">EXPOSE</span> <span class=\"hljs-number\">65001</span>\n\n<span class=\"hljs-keyword\">CMD</span><span class=\"bash\"> [<span class=\"hljs-string\">\"/bin/sh\"</span>,<span class=\"hljs-string\">\"-c\"</span>,<span class=\"hljs-string\">\"/usr/local/bin/dfdaemon --registry https://hub.c.163.com\"</span>]</span>\n</code></pre>\n</li>\n<li>\n<p><strong>dragonfly.conf</strong></p>\n<pre><code class=\"language-ini\"><span class=\"hljs-section\">[node]</span>\n<span class=\"hljs-attr\">address</span>=&lt;supernode_address&gt;\n</code></pre>\n</li>\n<li>\n<p><strong>构建镜像</strong></p>\n<pre><code class=\"language-bash\">docker build -t dfdaemon:0.2.0 .\n</code></pre>\n</li>\n</ul>\n<p>使用daemonset部署，需要使用hostnetwork，占用端口65001，并且需要准备一个configmap将dragonflg.conf挂载到容器的/etc/目录下面：</p>\n<pre><code class=\"language-ini\"><span class=\"hljs-comment\">## 这个配置需要是`supernode` 的域名</span>\n<span class=\"hljs-comment\">## cat dragonfly.conf</span>\n<span class=\"hljs-section\">[node]</span>\n<span class=\"hljs-attr\">address</span>=&lt;supernode_address&gt;\n\n<span class=\"hljs-comment\">## kubectl -n kube-system create configmap dragonfly-conf --from-file=dragonfly.conf</span>\n</code></pre>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps/v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">DaemonSet</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">dfdaemon</span>\n  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">kube-system</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">selector:</span>\n    <span class=\"hljs-attr\">matchLabels:</span>\n      <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">dfdaemon</span>\n  <span class=\"hljs-attr\">template:</span>\n    <span class=\"hljs-attr\">metadata:</span>\n      <span class=\"hljs-attr\">annotations:</span>\n        <span class=\"hljs-attr\">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class=\"hljs-string\">\"\"</span>\n      <span class=\"hljs-attr\">labels:</span>\n        <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">dfdaemon</span>\n    <span class=\"hljs-attr\">spec:</span>\n      <span class=\"hljs-attr\">containers:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">hub.c.163.com/hzlilanqing/dfdaemon:0.2.0</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">dfdaemon</span>\n        <span class=\"hljs-attr\">imagePullPolicy:</span> <span class=\"hljs-string\">IfNotPresent</span>\n        <span class=\"hljs-attr\">resources:</span>\n          <span class=\"hljs-attr\">requests:</span>\n            <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">250m</span>\n        <span class=\"hljs-attr\">volumeMounts:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/etc/dragonfly.conf</span>\n          <span class=\"hljs-attr\">subPath:</span> <span class=\"hljs-string\">dragonfly.conf</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">dragonconf</span>\n      <span class=\"hljs-attr\">hostNetwork:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-attr\">dnsPolicy:</span> <span class=\"hljs-string\">ClusterFirstWithHostNet</span>\n      <span class=\"hljs-attr\">restartPolicy:</span> <span class=\"hljs-string\">Always</span>\n      <span class=\"hljs-attr\">tolerations:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">effect:</span> <span class=\"hljs-string\">NoExecute</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">Exists</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">effect:</span> <span class=\"hljs-string\">NoSchedule</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">Exists</span>\n      <span class=\"hljs-attr\">volumes:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">dragonconf</span>\n        <span class=\"hljs-attr\">configMap:</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">dragonfly-conf</span>\n          <span class=\"hljs-attr\">items:</span>\n          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">dragonfly.conf</span>\n            <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">dragonfly.conf</span>\n</code></pre>\n<h4>2.3 docker启动参数设置</h4>\n<p>设置启动参数 <code>registry-mirror</code>，其中<code>65001</code>是<code>dfdaemon</code>的服务端口:</p>\n<ul>\n<li>\n<p>方法1: 修改<code>/etc/systemd/system/multi-user.target.wants/docker.service</code></p>\n<pre><code class=\"language-bash\">ExecStart=/usr/bin/dockerd -H fd:// --registry-mirror http://127.0.0.1:65001\n</code></pre>\n</li>\n<li>\n<p>方法2: 修改<code>/etc/docker/daemon.json</code></p>\n<pre><code class=\"language-json\">{\n  <span class=\"hljs-attr\">\"registry-mirrors\"</span>: [<span class=\"hljs-string\">\"http://127.0.0.1:65001\"</span>]\n}\n</code></pre>\n</li>\n</ul>\n<h2>附录</h2>\n<p>完整的部署yaml：</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps/v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Deployment</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">labels:</span>\n    <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">supernode</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">supernode</span>\n  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">kube-system</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">replicas:</span> <span class=\"hljs-number\">2</span>\n  <span class=\"hljs-attr\">selector:</span>\n    <span class=\"hljs-attr\">matchLabels:</span>\n      <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">supernode</span>\n  <span class=\"hljs-attr\">template:</span>\n    <span class=\"hljs-attr\">metadata:</span>\n      <span class=\"hljs-attr\">labels:</span>\n        <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">supernode</span>\n      <span class=\"hljs-attr\">annotations:</span>\n        <span class=\"hljs-attr\">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class=\"hljs-string\">\"\"</span>\n    <span class=\"hljs-attr\">spec:</span>\n      <span class=\"hljs-attr\">containers:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">hub.c.163.com/hzlilanqing/supernode:0.3.0</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">supernode</span>\n        <span class=\"hljs-attr\">ports:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-number\">8080</span>\n          <span class=\"hljs-attr\">hostPort:</span> <span class=\"hljs-number\">8080</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">tomcat</span>\n          <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">TCP</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-number\">8001</span>\n          <span class=\"hljs-attr\">hostPort:</span> <span class=\"hljs-number\">8001</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">register</span>\n          <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">TCP</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">containerPort:</span> <span class=\"hljs-number\">8002</span>\n          <span class=\"hljs-attr\">hostPort:</span> <span class=\"hljs-number\">8002</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">download</span>\n          <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">TCP</span>\n        <span class=\"hljs-attr\">resources:</span>\n          <span class=\"hljs-attr\">requests:</span>\n            <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">\"2\"</span>\n            <span class=\"hljs-attr\">memory:</span> <span class=\"hljs-string\">4Gi</span>\n        <span class=\"hljs-attr\">volumeMounts:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/etc/localtime</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ltime</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/home/admin/supernode/logs/</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">log</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/home/admin/supernode/repo/</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">data</span>\n      <span class=\"hljs-attr\">hostNetwork:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-attr\">dnsPolicy:</span> <span class=\"hljs-string\">ClusterFirstWithHostNet</span>\n      <span class=\"hljs-attr\">restartPolicy:</span> <span class=\"hljs-string\">Always</span>\n      <span class=\"hljs-attr\">tolerations:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">effect:</span> <span class=\"hljs-string\">NoExecute</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">Exists</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">effect:</span> <span class=\"hljs-string\">NoSchedule</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">Exists</span>\n      <span class=\"hljs-attr\">nodeSelector:</span>\n        <span class=\"hljs-attr\">node-role.kubernetes.io/master:</span> <span class=\"hljs-string\">\"\"</span>\n      <span class=\"hljs-attr\">volumes:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hostPath:</span>\n          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/etc/localtime</span>\n          <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">\"\"</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">ltime</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hostPath:</span>\n          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/data/log/supernode</span>\n          <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">\"\"</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">log</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">hostPath:</span>\n          <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/data/supernode/repo/</span>\n          <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">\"\"</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">data</span>\n        \n<span class=\"hljs-meta\">---</span>\n\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">Service</span>\n<span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">supernode</span>\n  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">kube-system</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">selector:</span>\n    <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">supernode</span>\n  <span class=\"hljs-attr\">ports:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">register</span>\n    <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">TCP</span>\n    <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">8001</span>\n    <span class=\"hljs-attr\">targetPort:</span> <span class=\"hljs-number\">8001</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">download</span>\n    <span class=\"hljs-attr\">protocol:</span> <span class=\"hljs-string\">TCP</span>\n    <span class=\"hljs-attr\">port:</span> <span class=\"hljs-number\">8002</span>\n    <span class=\"hljs-attr\">targetPort:</span> <span class=\"hljs-number\">8002</span>\n\n<span class=\"hljs-meta\">---</span>\n<span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">apps/v1</span>\n<span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">DaemonSet</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">dfdaemon</span>\n  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">kube-system</span>\n<span class=\"hljs-attr\">spec:</span>\n  <span class=\"hljs-attr\">selector:</span>\n    <span class=\"hljs-attr\">matchLabels:</span>\n      <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">dfdaemon</span>\n  <span class=\"hljs-attr\">template:</span>\n    <span class=\"hljs-attr\">metadata:</span>\n      <span class=\"hljs-attr\">annotations:</span>\n        <span class=\"hljs-attr\">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class=\"hljs-string\">\"\"</span>\n      <span class=\"hljs-attr\">labels:</span>\n        <span class=\"hljs-attr\">app:</span> <span class=\"hljs-string\">dfdaemon</span>\n    <span class=\"hljs-attr\">spec:</span>\n      <span class=\"hljs-attr\">containers:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">hub.c.163.com/hzlilanqing/dfdaemon:0.2.0</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">dfdaemon</span>\n        <span class=\"hljs-attr\">imagePullPolicy:</span> <span class=\"hljs-string\">IfNotPresent</span>\n        <span class=\"hljs-attr\">resources:</span>\n          <span class=\"hljs-attr\">requests:</span>\n            <span class=\"hljs-attr\">cpu:</span> <span class=\"hljs-string\">250m</span>\n        <span class=\"hljs-attr\">volumeMounts:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">mountPath:</span> <span class=\"hljs-string\">/etc/dragonfly.conf</span>\n          <span class=\"hljs-attr\">subPath:</span> <span class=\"hljs-string\">dragonfly.conf</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">dragonconf</span>\n      <span class=\"hljs-attr\">hostNetwork:</span> <span class=\"hljs-literal\">true</span>\n      <span class=\"hljs-attr\">dnsPolicy:</span> <span class=\"hljs-string\">ClusterFirstWithHostNet</span>\n      <span class=\"hljs-attr\">restartPolicy:</span> <span class=\"hljs-string\">Always</span>\n      <span class=\"hljs-attr\">tolerations:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">effect:</span> <span class=\"hljs-string\">NoExecute</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">Exists</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">effect:</span> <span class=\"hljs-string\">NoSchedule</span>\n        <span class=\"hljs-attr\">operator:</span> <span class=\"hljs-string\">Exists</span>\n      <span class=\"hljs-attr\">volumes:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">dragonconf</span>\n        <span class=\"hljs-attr\">configMap:</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">dragonfly-conf</span>\n          <span class=\"hljs-attr\">items:</span>\n          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">key:</span> <span class=\"hljs-string\">dragonfly.conf</span>\n            <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">dragonfly.conf</span>\n\n<span class=\"hljs-meta\">---</span>\n<span class=\"hljs-attr\">apiVersion:</span> <span class=\"hljs-string\">v1</span>\n<span class=\"hljs-attr\">data:</span>\n  <span class=\"hljs-attr\">dragonfly.conf:</span> <span class=\"hljs-string\">|\n    [node]\n    address=supernode\n</span><span class=\"hljs-attr\">kind:</span> <span class=\"hljs-string\">ConfigMap</span>\n<span class=\"hljs-attr\">metadata:</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">dragonfly-conf</span>\n  <span class=\"hljs-attr\">namespace:</span> <span class=\"hljs-string\">kube-system</span>\n</code></pre>\n<h2>参考文档</h2>\n<blockquote>\n<ol>\n<li><a href=\"https://d7y.io/\">https://d7y.io/</a></li>\n</ol>\n</blockquote>\n",
  "link": "/zh-cn/blog/deploy-dragonfly-on-k8s.html",
  "meta": {
    "hidden": "false",
    "title": "在Kubernetes上部署Dragonfly",
    "keywords": "kubernetes, dragonfly",
    "description": "本文介绍如何在Kubernetes上部署Dragonfly，包括supernode，dfdaemon，dfget。",
    "author": "shenlanse",
    "date": "2018-12-22"
  }
}