<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="keywords" content="dragonfly,wise2c" />
    <meta name="description" content="本文档介绍了dragonfly 使用docker proxy 实现 https" />
    <!-- 网页标签标题 -->
    <title>睿云智合基于 Dragonfly 支持docker proxy https</title>
    <link rel="shortcut icon" href="/img/favicon.ico"/>
    <link rel="stylesheet" href="/build/blogDetail.css" />
  </head>
  <body>
    <div id="root"><div class="blog-detail-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="https://img.alicdn.com/tfs/TB1ThlOucfpK1RjSZFOXXa6nFXa-266-72.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/zh-cn/index.html" target="_self">首页</a></li><li class="menu-item menu-item-normal"><a href="/zh-cn/docs/overview/what_is_dragonfly.html" target="_self">文档</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/zh-cn/blog/index.html" target="_self">博客</a></li><li class="menu-item menu-item-normal"><a href="/zh-cn/community/index.html" target="_self">社区</a></li></ul></div></div></header><section class="blog-content markdown-body"><p><img src="https://camo.githubusercontent.com/3890ebff894a525c0747e1945f991b10b42284b4/68747470733a2f2f6d6d62697a2e717069632e636e2f6d6d62697a5f706e672f4a533266664d4958736962304d564d7a504556414b58763233545070304341463559696253696133313839364e7737654b4f546837777948574c47736e6c4e665a496f366669626961444d6d7176615333716d5657554d323959412f3634303f77785f666d743d706e672674703d7765627026777866726f6d3d352677785f6c617a793d312677785f636f3d31" alt="611.jpg | center | 827x347"></p>
<h1>睿云智合基于 Dragonfly 支持docker proxy https</h1>
<p align='right'>by <a href="https://github.com/songshuone">吴鹏</a></p>
<h2>1、部署https harbor</h2>
<p><a href="https://github.com/goharbor/harbor/blob/master/docs/configure_https.md">https://github.com/goharbor/harbor/blob/master/docs/configure_https.md</a></p>
<h2>2、部署docker_proxy</h2>
<h3>pull images</h3>
<p><strong>pull_images.sh</strong></p>
<pre><code class="language-bash"><span class="hljs-meta">#!/bin/sh</span>
docker_registry_proxy=<span class="hljs-string">"dockerhubwp/docker_proxy_nginx:latest"</span>
supernode=<span class="hljs-string">"registry.cn-hangzhou.aliyuncs.com/alidragonfly/supernode:0.2.0"</span>
dfclient=<span class="hljs-string">"dockerhubwp/dfclient:latest"</span>

images=<span class="hljs-string">"<span class="hljs-variable">${docker_registry_proxy}</span> <span class="hljs-variable">${supernode}</span> <span class="hljs-variable">${dfclient}</span>"</span>

<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">pullImage</span></span>(){
    <span class="hljs-keyword">for</span> image <span class="hljs-keyword">in</span> <span class="hljs-variable">${images}</span>; <span class="hljs-keyword">do</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"pull image ======&gt;<span class="hljs-variable">${image}</span>"</span>
        docker pull <span class="hljs-variable">${image}</span>
    <span class="hljs-keyword">done</span>
}

pullImage
</code></pre>
<p><strong>docker_proxy.sh</strong></p>
<pre><code class="language-bash"><span class="hljs-meta">#! /bin/sh
</span>
<span class="hljs-comment"># Separate deployment docker_proxy</span>
<span class="hljs-comment"># dfdaemon and docker registry map</span>
<span class="hljs-comment"># example  x.x.x</span>
registry=<span class="hljs-string">"harbor域名"</span>
containername=docker_registry_proxy

<span class="hljs-comment"># 你需要配置的dns 服务器 (如：dnsmasq)</span>
DNS_SERVER=<span class="hljs-string">"dns-server"</span>
docker_registry_proxy=<span class="hljs-string">"dockerhubwp/docker_proxy_nginx:latest"</span>

<span class="hljs-comment"># get localhost ip</span>
ipaddr=$(ip addr | awk <span class="hljs-string">'/^[0-9]+: / {}; /inet.*global/ {print gensub(/(.*)\/(.*)/, "\\1", "g", $2)}'</span>)
localhostIp=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">${ipaddr}</span> | cut -d <span class="hljs-string">" "</span> -f 1)

<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">changeDockerProxy</span></span>() {
    mkdir -p /etc/systemd/system/docker.service.d
    cat &lt;&lt;EOD &gt;/etc/systemd/system/docker.service.d/http-proxy.conf
[Service]
Environment=<span class="hljs-string">"HTTP_PROXY=http://127.0.0.1:3128/"</span>
Environment=<span class="hljs-string">"HTTPS_PROXY=http://127.0.0.1:3128/"</span>
EOD
}

<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">dockerDockerProxyRun</span></span>() {
    <span class="hljs-keyword">if</span> [[ 0 != $(docker ps -a | grep <span class="hljs-variable">${containername}</span> | wc -l) ]]; <span class="hljs-keyword">then</span>
        docker rm -f <span class="hljs-variable">${containername}</span>
    <span class="hljs-keyword">fi</span>
    docker run --restart=always --privileged=<span class="hljs-literal">true</span> --name <span class="hljs-variable">${containername}</span> -d -p 0.0.0.0:3128:3128 -v /etc/docker_proxy_nginx/docker_mirror_certs:/ca -v /var/<span class="hljs-built_in">log</span>/docker_proxy_nginx:/var/<span class="hljs-built_in">log</span>/nginx/ -e DRAGONFLY_REGISTRIES=<span class="hljs-string">"<span class="hljs-variable">${registry}</span>,http://<span class="hljs-variable">${localhostIp}</span>:65001"</span> -e REGISTRIES=<span class="hljs-string">"<span class="hljs-variable">${registry}</span>"</span> -e DNS_SERVER=<span class="hljs-variable">${DNS_SERVER}</span> <span class="hljs-variable">${docker_registry_proxy}</span>
}

changeDockerProxy

systemctl daemon-reload
systemctl restart docker

dockerDockerProxyRun
</code></pre>
<h2>3、部署dragonfly</h2>
<h3>部署Supernode</h3>
<p><strong><a href="http://supernode.sh">supernode.sh</a></strong></p>
<pre><code class="language-bash"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-comment"># Separate deployment supernode</span>

supernode=<span class="hljs-string">"registry.cn-hangzhou.aliyuncs.com/alidragonfly/supernode:0.2.0"</span>
containername=supernode

<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">superNode</span></span>() {
    <span class="hljs-keyword">if</span> [[ 0 != $(docker ps -a | grep <span class="hljs-variable">${containername}</span> | wc -l) ]]; <span class="hljs-keyword">then</span>
        docker rm -f <span class="hljs-variable">${containername}</span>
    <span class="hljs-keyword">fi</span>
    docker run --name <span class="hljs-variable">${containername}</span> --restart=always -d -p 8001:8001 -p 8002:8002 <span class="hljs-variable">${supernode}</span>
}
superNode
</code></pre>
<h3>部署dfclient</h3>
<p><strong><a href="http://dfclient.sh">dfclient.sh</a></strong></p>
<pre><code class="language-bash"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-comment"># Separate deployment docker_proxy</span>

dfclient=<span class="hljs-string">"dockerhubwp/dfclient:latest"</span>

<span class="hljs-comment">#harbor 地址</span>
dfdaemon_registry=<span class="hljs-string">"https://x.x.x"</span>
containername=dfclient

<span class="hljs-comment"># supernode ips  example (10.0.0.160,10.0.0.162)</span>
supernodes=<span class="hljs-string">"supernodeip"</span>


ipaddr=$(ip addr | awk <span class="hljs-string">'/^[0-9]+: / {}; /inet.*global/ {print gensub(/(.*)\/(.*)/, "\\1", "g", $2)}'</span>)
localhostIp=$(<span class="hljs-built_in">echo</span> <span class="hljs-variable">${ipaddr}</span> | cut -d <span class="hljs-string">" "</span> -f 1)

cat &lt;&lt;EOD &gt;/etc/dragonfly.conf
[node]
address=<span class="hljs-variable">${supernodes}</span>
EOD

<span class="hljs-keyword">function</span> <span class="hljs-function"><span class="hljs-title">startDfClient</span></span>() {
    <span class="hljs-keyword">if</span> [[ 0 != $(docker ps -a | grep <span class="hljs-variable">${containername}</span> | wc -l) ]]; <span class="hljs-keyword">then</span>
        docker rm -f <span class="hljs-variable">${containername}</span>
    <span class="hljs-keyword">fi</span>
    docker run --name <span class="hljs-variable">${containername}</span> --restart=always -d  -p 65001:65001 -v /root/.small-dragonfly:/root/.small-dragonfly -v /etc/dragonfly.conf:/etc/dragonfly.conf  -e dfdaemon_registry=<span class="hljs-variable">${dfdaemon_registry}</span> -e localhostIp=<span class="hljs-variable">${localhostIp}</span> <span class="hljs-variable">${dfclient}</span>
}

startDfClient
</code></pre>
<h3>最后</h3>
<p><strong><a href="http://trust.sh">trust.sh</a></strong></p>
<pre><code class="language-bash"><span class="hljs-meta">#!/bin/sh
</span>
<span class="hljs-comment"># trust ca</span>
curl http://127.0.0.1:3128/ca.crt &gt;/etc/pki/ca-trust/<span class="hljs-built_in">source</span>/anchors/docker_proxy_nginx.crt

update-ca-trust
</code></pre>
<h3>测试: 拉取镜像</h3>
<pre><code class="language-bash">docker pull x.x.x/library/nginx:latest
</code></pre>
<hr>
<p>原文链接：<a href="https://mp.weixin.qq.com/s/95mX8cDox5bmgQ2xGHLPqQ">https://mp.weixin.qq.com/s/95mX8cDox5bmgQ2xGHLPqQ</a></p>
<p>参考：</p>
<ul>
<li><a href="https://d7y.io/zh-cn/">https://d7y.io/zh-cn/</a></li>
<li><a href="https://github.com/goharbor/harbor/">https://github.com/goharbor/harbor/</a></li>
<li><a href="https://github.com/rpardini/docker-registry-proxy">https://github.com/rpardini/docker-registry-proxy</a></li>
<li><a href="https://github.com/chobits/ngx_http_proxy_connect_module">https://github.com/chobits/ngx_http_proxy_connect_module</a></li>
</ul>
</section><footer class="footer-container"><div class="footer-body"><img src="https://img.alicdn.com/tfs/TB1H9Eht9zqK1RjSZPxXXc4tVXa-266-72.png"/><div class="cols-container"><div class="col col-12"><h3>愿景</h3><p>Dragonfly 致力于解决大规模文件分发的效率问题，打造容器镜像分发的第一解决方案和标准规范，并为用户提供高可用、高效率以及简单易用的文件及镜像分发服务。</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/overview/what_is_dragonfly.html" target="_self">什么是 Dragonfly？</a></dd><dd><a href="/zh-cn/docs/quickstart.html" target="_self">快速开始</a></dd><dd><a href="/en-us/docs/userguide/install_server.html" target="_self">安装服务端</a></dd><dd><a href="/en-us/docs/userguide/install_client.html" target="_self">安装客户端</a></dd><dd><a href="/en-us/docs/userguide/download_files.html" target="_self">下载文件</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="/zh-cn/blog/index.html" target="_self">博客</a></dd><dd><a href="/zh-cn/community/index.html" target="_self">社区</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2018 dragonflyoss<!-- --> | <a href="https://www.cnzz.com/stat/website.php?web_id=1275746144" target="_blank"><img border="0" hspace="0" vspace="0" src="https://icon.cnzz.com/img/pic.gif"/></a></span></div></div></footer></div></div>
    <script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
    <script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
    <script>
      window.rootPath = '';
    </script>
    <script src="/build/blogDetail.js"></script>
    <script src="https://s23.cnzz.com/z_stat.php?id=1275746144&web_id=1275746144&show=none" language="JavaScript"></script>
  </body>
</html>
