<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="keywords" content="kubernetes, dragonfly" />
    <meta name="description" content="本文介绍如何在Kubernetes上部署Dragonfly，包括supernode，dfdaemon，dfget。" />
    <!-- 网页标签标题 -->
    <title>在Kubernetes上部署Dragonfly</title>
    <link rel="shortcut icon" href="/img/favicon.ico"/>
    <link rel="stylesheet" href="/build/blogDetail.css" />
  </head>
  <body>
    <div id="root"><div class="blog-detail-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="https://img.alicdn.com/tfs/TB1ThlOucfpK1RjSZFOXXa6nFXa-266-72.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="/zh-cn/index.html" target="_self">首页</a></li><li class="menu-item menu-item-normal"><a href="/zh-cn/docs/overview/what_is_dragonfly.html" target="_self">文档</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/zh-cn/blog/index.html" target="_self">博客</a></li><li class="menu-item menu-item-normal"><a href="/zh-cn/community/index.html" target="_self">社区</a></li></ul></div></div></header><section class="blog-content markdown-body"><h1>在Kubernetes上部署Dragonfly</h1>
<p align='right'>by <a href="https://github.com/shenlanse">shenlanse</a></p>
<h2>1 说明</h2>
<ul>
<li><code>supernode</code> 组件至少需要两节点部署，hostnetwork，一般部署在管理节点，比如k8s master上。</li>
<li><code>supernode</code> 需要使用8001、8002端口。如果跟kube-apiserver部署在一个节点上，需要确保不要有端口冲突。</li>
<li><code>supernode</code> 所在节点对网络带宽、磁盘空间、磁盘IO要求较高。</li>
<li><code>dfdaemon</code> 组件使用daemonset部署在所有的node节点上，hostnetwork，占用65001端口</li>
<li>需要修改所有node的docker启动参数 <em><strong>--registry-mirror <a href="http://127.0.0.1:65001">http://127.0.0.1:65001</a></strong></em>。</li>
</ul>
<h2>2 部署</h2>
<p>其中 <code>supernode</code> 部署在管理节点，<code>dfget</code> 和<code>dfdaemon</code> 部署在所有的node上面。</p>
<h3>2.1 supernode</h3>
<p>三种部署方式：</p>
<ul>
<li>直接跑docker 容器</li>
<li>kubelet管理静态pod</li>
<li>deployment部署</li>
</ul>
<blockquote>
<p>NOTE： 官方提供的镜像是0.2.0，继委自己打了个0.3.0的镜像，这个镜像是基于master分支的。问了一下已经部署上线蜻蜓的去哪儿网和美团的工程师，他们用的是官方的0.2.0镜像。</p>
</blockquote>
<h5>2.1.1 docker容器</h5>
<pre><code class="language-bash">docker run -d -p 8001:8001 -p 8002:8002 -v /data/<span class="hljs-built_in">log</span>/supernode/:/home/admin/supernode/logs/ -v /data/supernode/repo/:/home/admin/supernode/repo/ hub.c.163.com/hzlilanqing/supernode:0.3.0
</code></pre>
<h5>2.1.2 静态pod</h5>
<pre><code class="language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pod</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">supernode</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">containers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">hub.c.163.com/hzlilanqing/supernode:0.3.0</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">supernode</span>
    <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">tomcat</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8001</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">register</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8002</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">download</span>
    <span class="hljs-attr">resources:</span>
      <span class="hljs-attr">requests:</span>
        <span class="hljs-attr">cpu:</span> <span class="hljs-string">"2"</span>
        <span class="hljs-attr">memory:</span> <span class="hljs-string">4Gi</span>
    <span class="hljs-attr">volumeMounts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/localtime</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">ltime</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/home/admin/supernode/logs/</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">log</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/home/admin/supernode/repo/</span>
      <span class="hljs-attr">name:</span> <span class="hljs-string">data</span>
  <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirstWithHostNet</span>
  <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span>
  <span class="hljs-attr">tolerations:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoExecute</span>
    <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span>
    <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span>
  <span class="hljs-attr">nodeSelector:</span>
    <span class="hljs-attr">node-role.kubernetes.io/master:</span> <span class="hljs-string">""</span>
  <span class="hljs-attr">volumes:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/localtime</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">ltime</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/data/log/supernode</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">log</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/data/supernode/repo/</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">data</span>
</code></pre>
<h5>2.1.3 deployment</h5>
<pre><code class="language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">supernode</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">supernode</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">supernode</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">supernode</span>
      <span class="hljs-attr">annotations:</span>
        <span class="hljs-attr">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="hljs-string">""</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">hub.c.163.com/hzlilanqing/supernode:0.3.0</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">supernode</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">hostPort:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">tomcat</span>
          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8001</span>
          <span class="hljs-attr">hostPort:</span> <span class="hljs-number">8001</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">register</span>
          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8002</span>
          <span class="hljs-attr">hostPort:</span> <span class="hljs-number">8002</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">download</span>
          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"2"</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">4Gi</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/localtime</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">ltime</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/home/admin/supernode/logs/</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">log</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/home/admin/supernode/repo/</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">data</span>
      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirstWithHostNet</span>
      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span>
      <span class="hljs-attr">tolerations:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoExecute</span>
        <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span>
        <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span>
      <span class="hljs-attr">nodeSelector:</span>
        <span class="hljs-attr">node-role.kubernetes.io/master:</span> <span class="hljs-string">""</span>
      <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/localtime</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">""</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">ltime</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">/data/log/supernode</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">""</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">log</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">/data/supernode/repo/</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">""</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">data</span>

<span class="hljs-meta">---</span>

<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">supernode</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">supernode</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">register</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">8001</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8001</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">download</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">8002</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8002</span>

</code></pre>
<h4>2.2 dfget &amp; dfdaemon</h4>
<ul>
<li>
<p><strong>Dockerfile</strong></p>
<pre><code class="language-dockerfile"><span class="hljs-keyword">FROM</span> debian:<span class="hljs-number">7</span>
 
<span class="hljs-keyword">MAINTAINER</span> <span class="hljs-string">"hzlilanqing@corp.netease.com"</span>

<span class="hljs-keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; apt-get install -y python wget &amp;&amp; \
    wget http://dragonfly-os.oss-cn-beijing.aliyuncs.com/df-client_0.2.0_linux_amd64.tar.gz  &amp;&amp; \
    tar -zxf df-client_0.2.0_linux_amd64.tar.gz &amp;&amp; \
    cp -R df-client/* /usr/<span class="hljs-built_in">local</span>/bin/ &amp;&amp; \
    rm -rf df-client_0.2.0_linux_amd64.tar.gz df-client</span>

<span class="hljs-keyword">COPY</span><span class="bash"> ./dragonfly.conf /etc/</span>

<span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">65001</span>

<span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">"/bin/sh"</span>,<span class="hljs-string">"-c"</span>,<span class="hljs-string">"/usr/local/bin/dfdaemon --registry https://hub.c.163.com"</span>]</span>
</code></pre>
</li>
<li>
<p><strong>dragonfly.conf</strong></p>
<pre><code class="language-ini"><span class="hljs-section">[node]</span>
<span class="hljs-attr">address</span>=&lt;supernode_address&gt;
</code></pre>
</li>
<li>
<p><strong>构建镜像</strong></p>
<pre><code class="language-bash">docker build -t dfdaemon:0.2.0 .
</code></pre>
</li>
</ul>
<p>使用daemonset部署，需要使用hostnetwork，占用端口65001，并且需要准备一个configmap将dragonflg.conf挂载到容器的/etc/目录下面：</p>
<pre><code class="language-ini"><span class="hljs-comment">## 这个配置需要是`supernode` 的域名</span>
<span class="hljs-comment">## cat dragonfly.conf</span>
<span class="hljs-section">[node]</span>
<span class="hljs-attr">address</span>=&lt;supernode_address&gt;

<span class="hljs-comment">## kubectl -n kube-system create configmap dragonfly-conf --from-file=dragonfly.conf</span>
</code></pre>
<pre><code class="language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">dfdaemon</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">dfdaemon</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">annotations:</span>
        <span class="hljs-attr">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="hljs-string">""</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">dfdaemon</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">hub.c.163.com/hzlilanqing/dfdaemon:0.2.0</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">dfdaemon</span>
        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">250m</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/dragonfly.conf</span>
          <span class="hljs-attr">subPath:</span> <span class="hljs-string">dragonfly.conf</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">dragonconf</span>
      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirstWithHostNet</span>
      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span>
      <span class="hljs-attr">tolerations:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoExecute</span>
        <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span>
        <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span>
      <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">dragonconf</span>
        <span class="hljs-attr">configMap:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">dragonfly-conf</span>
          <span class="hljs-attr">items:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">dragonfly.conf</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">dragonfly.conf</span>
</code></pre>
<h4>2.3 docker启动参数设置</h4>
<p>设置启动参数 <code>registry-mirror</code>，其中<code>65001</code>是<code>dfdaemon</code>的服务端口:</p>
<ul>
<li>
<p>方法1: 修改<code>/etc/systemd/system/multi-user.target.wants/docker.service</code></p>
<pre><code class="language-bash">ExecStart=/usr/bin/dockerd -H fd:// --registry-mirror http://127.0.0.1:65001
</code></pre>
</li>
<li>
<p>方法2: 修改<code>/etc/docker/daemon.json</code></p>
<pre><code class="language-json">{
  <span class="hljs-attr">"registry-mirrors"</span>: [<span class="hljs-string">"http://127.0.0.1:65001"</span>]
}
</code></pre>
</li>
</ul>
<h2>附录</h2>
<p>完整的部署yaml：</p>
<pre><code class="language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">supernode</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">supernode</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">supernode</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">supernode</span>
      <span class="hljs-attr">annotations:</span>
        <span class="hljs-attr">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="hljs-string">""</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">hub.c.163.com/hzlilanqing/supernode:0.3.0</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">supernode</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">hostPort:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">tomcat</span>
          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8001</span>
          <span class="hljs-attr">hostPort:</span> <span class="hljs-number">8001</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">register</span>
          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8002</span>
          <span class="hljs-attr">hostPort:</span> <span class="hljs-number">8002</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">download</span>
          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"2"</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">4Gi</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/localtime</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">ltime</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/home/admin/supernode/logs/</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">log</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/home/admin/supernode/repo/</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">data</span>
      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirstWithHostNet</span>
      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span>
      <span class="hljs-attr">tolerations:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoExecute</span>
        <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span>
        <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span>
      <span class="hljs-attr">nodeSelector:</span>
        <span class="hljs-attr">node-role.kubernetes.io/master:</span> <span class="hljs-string">""</span>
      <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/localtime</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">""</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">ltime</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">/data/log/supernode</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">""</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">log</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">hostPath:</span>
          <span class="hljs-attr">path:</span> <span class="hljs-string">/data/supernode/repo/</span>
          <span class="hljs-attr">type:</span> <span class="hljs-string">""</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">data</span>
        
<span class="hljs-meta">---</span>

<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">supernode</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">supernode</span>
  <span class="hljs-attr">ports:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">register</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">8001</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8001</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">download</span>
    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">8002</span>
    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8002</span>

<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">dfdaemon</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">dfdaemon</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">annotations:</span>
        <span class="hljs-attr">scheduler.alpha.kubernetes.io/critical-pod:</span> <span class="hljs-string">""</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">dfdaemon</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">hub.c.163.com/hzlilanqing/dfdaemon:0.2.0</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">dfdaemon</span>
        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">250m</span>
        <span class="hljs-attr">volumeMounts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/etc/dragonfly.conf</span>
          <span class="hljs-attr">subPath:</span> <span class="hljs-string">dragonfly.conf</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">dragonconf</span>
      <span class="hljs-attr">hostNetwork:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirstWithHostNet</span>
      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span>
      <span class="hljs-attr">tolerations:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoExecute</span>
        <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">effect:</span> <span class="hljs-string">NoSchedule</span>
        <span class="hljs-attr">operator:</span> <span class="hljs-string">Exists</span>
      <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">dragonconf</span>
        <span class="hljs-attr">configMap:</span>
          <span class="hljs-attr">name:</span> <span class="hljs-string">dragonfly-conf</span>
          <span class="hljs-attr">items:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">dragonfly.conf</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">dragonfly.conf</span>

<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">dragonfly.conf:</span> <span class="hljs-string">|
    [node]
    address=supernode
</span><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">dragonfly-conf</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span>
</code></pre>
<h2>参考文档</h2>
<blockquote>
<ol>
<li><a href="https://d7y.io/">https://d7y.io/</a></li>
</ol>
</blockquote>
</section><footer class="footer-container"><div class="footer-body"><img src="https://img.alicdn.com/tfs/TB1H9Eht9zqK1RjSZPxXXc4tVXa-266-72.png"/><div class="cols-container"><div class="col col-12"><h3>愿景</h3><p>Dragonfly 致力于解决大规模文件分发的效率问题，打造容器镜像分发的第一解决方案和标准规范，并为用户提供高可用、高效率以及简单易用的文件及镜像分发服务。</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/overview/what_is_dragonfly.html" target="_self">什么是 Dragonfly？</a></dd><dd><a href="/zh-cn/docs/quickstart.html" target="_self">快速开始</a></dd><dd><a href="/en-us/docs/userguide/install_server.html" target="_self">安装服务端</a></dd><dd><a href="/en-us/docs/userguide/install_client.html" target="_self">安装客户端</a></dd><dd><a href="/en-us/docs/userguide/download_files.html" target="_self">下载文件</a></dd></dl></div><div class="col col-6"><dl><dt>资源</dt><dd><a href="/zh-cn/blog/index.html" target="_self">博客</a></dd><dd><a href="/zh-cn/community/index.html" target="_self">社区</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2018 dragonflyoss<!-- --> | <a href="https://www.cnzz.com/stat/website.php?web_id=1275746144" target="_blank"><img border="0" hspace="0" vspace="0" src="https://icon.cnzz.com/img/pic.gif"/></a></span></div></div></footer></div></div>
    <script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
    <script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
    <script>
      window.rootPath = '';
    </script>
    <script src="/build/blogDetail.js"></script>
    <script src="https://s23.cnzz.com/z_stat.php?id=1275746144&web_id=1275746144&show=none" language="JavaScript"></script>
  </body>
</html>
